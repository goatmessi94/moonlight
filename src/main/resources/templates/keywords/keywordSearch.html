<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/common :: head('고객처')">
</head>

<body>
<div class="wrapper">

    <div th:replace="fragments/common :: main-header">
    </div>

    <div th:replace="fragments/common :: sidebar(current ='2', current2 = '2-2')">
    </div>

    <div class="main-panel">
        <div class="content">
            <div class="page-inner">
                <div class="page-header">
                    <h4 class="page-title">고객처</h4>
                    <ul class="breadcrumbs">
                        <li class="nav-home">
                            <a href="#">
                                <i class="flaticon-home"></i>
                            </a>
                        </li>
                        <li class="separator">
                            <i class="flaticon-right-arrow"></i>
                        </li>
                        <li class="nav-item">
                            <a href="#">기초정보</a>
                        </li>
                        <li class="separator">
                            <i class="flaticon-right-arrow"></i>
                        </li>
                        <li class="nav-item">
                            <a href="#">고객처</a>
                        </li>
                    </ul>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header row">
                                <div class="col-6 align-self-center">
                                    <h4 class="card-title">고객처 조회</h4>
                                </div>
                                <div class="col-6 text-right">
                                    <button class="btn btn-primary"
                                            onclick="location.href='/information/vendorForm?switch=create'">신규
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <div id="selectBox">
                                        <span>분야</span>
                                        <select id="bigclass" class="form-select" onchange="bigSelectBoxdraw()">
                                            <option value="all" selected="selected">all</option>
                                            <option value="패션의류">패션의류</option>
                                            <option value="화장품/미용" >화장품/미용</option>
                                            <option value="디지털/가전">디지털/가전</option>
                                            <option value="가구/인테리어">가구/인테리어</option>
                                            <option value="출산/육아">출산/육아</option>
                                            <option value="식품">식품</option>
                                            <option value="스포츠/레저">스포츠/레저</option>
                                            <option value="생활/건강">생활/건강</option>
                                            <option value="여가/생활편의">여가/생활편의</option>
                                            <option value="패션잡화">패션잡화</option>
                                            <option value="도서">도서</option>
                                        </select>
                                        <button class="btn btn-primary" onclick="drawKeywordList()">조회
                                        </button>
                                    </div>
                                    <table id="keywordSearch"
                                           class="display table table-striped table-hover text-nowrap">
                                        <thead>
                                        <tr>
                                            <th>번호</th>
                                            <th>키워드명</th>
                                            <th>대분류</th>
                                            <th>중분류</th>
                                            <th>소분류</th>
                                            <th>상세분류</th>
                                            <th>검색량</th>
                                            <th>네이버 경쟁강도</th>
                                            <th>인사이트 경쟁강도</th>
                                            <th>상품수</th>
                                        </tr>
                                        </thead>
                                        <tfoot>
                                        <tr>
                                            <th>번호</th>
                                            <th>키워드명</th>
                                            <th>대분류</th>
                                            <th>중분류</th>
                                            <th>소분류</th>
                                            <th>상세분류</th>
                                            <th>검색량</th>
                                            <th>네이버 경쟁강도</th>
                                            <th>인사이트 경쟁강도</th>
                                            <th>상품수</th>
                                        </tr>
                                        </tfoot>
                                        <tbody>
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer th:replace="fragments/common :: footer"></footer>
    </div>
</div>
</body>
<div th:replace="fragments/common :: import_js"></div>

<script th:inline="javascript">
    function bigSelectBoxdraw() {
        let middleClass = document.querySelector('#middleclass');
        if (middleClass != null) {
            middleClass.remove();
        }

        let smallClass = document.querySelector('#smallclass');
        if (smallClass != null) {
            smallClass.remove();
        }

        let detailClass = document.querySelector('#detailclass');
        if (detailClass != null) {
            detailClass.remove();
        }
        let bigClass = document.getElementById('bigclass');
        bigClass = bigClass.options[bigClass.selectedIndex].text;

        let sendData = {
            bigClass : bigClass
        }

        let callback = function (data) {
            if (data.length > 0) {
                console.log(data);
                let middleSelectBox = document.createElement("select");
                middleSelectBox.id = "middleclass";
                //2분류 전체 조회 시
                let all = document.createElement("option");
                all.value = null;
                all.text = "all";
                middleSelectBox.add(all, null);
                let opt = [];
                for (i=0; i<data.length; i++) {
                    opt[i] = document.createElement("option");
                    opt[i].value = data[i];
                    opt[i].text = data[i];
                    middleSelectBox.add(opt[i], null);
                }
                document.querySelector('#selectBox').insertBefore(middleSelectBox, document.querySelector("#selectBox").childNodes[4]);
                $("#middleclass").change(function () {
                        middleSelectBoxdraw();
                    }
                )
            }
        }
        sendAjaxPost(cpHolder + "/api/naverCategory", JSON.stringify(sendData), callback);
    }

    function middleSelectBoxdraw() {
        let smallClass = document.querySelector('#smallclass');
        if (smallClass != null) {
            smallClass.remove();
        }

        let detailClass = document.querySelector('#detailclass');
        if (detailClass != null) {
            detailClass.remove();
        }

        let bigClass = document.getElementById('bigclass');
        bigClass = bigClass.options[bigClass.selectedIndex].text;

        let middleClass = document.getElementById('middleclass');
        middleClass = middleClass.options[middleClass.selectedIndex].text;

        let sendData = {
            bigClass : bigClass,
            middleClass : middleClass
        }

        let callback = function (data) {
            if (data.length > 0) {
                console.log(data);
                let smallSelectBox = document.createElement("select");
                smallSelectBox.id = "smallclass";
                //3분류 전체 조회 시
                let all = document.createElement("option");
                all.value = null;
                all.text = "all";
                smallSelectBox.add(all, null);
                let opt = [];
                for (i=0; i<data.length; i++) {
                    opt[i] = document.createElement("option");
                    opt[i].value = data[i];
                    opt[i].text = data[i];
                    smallSelectBox.add(opt[i], null);
                }
                document.querySelector('#selectBox').insertBefore(smallSelectBox, document.querySelector("#selectBox").childNodes[5]);
                $("#smallclass").change(function () {
                        smallSelectBoxdraw();
                    }
                )
            }
        }
        sendAjaxPost(cpHolder + "/api/naverCategory", JSON.stringify(sendData), callback);
    }

    function smallSelectBoxdraw() {
        let detailClass = document.querySelector('#detailclass');
        if (detailClass != null) {
            detailClass.remove();
        }

        let bigClass = document.getElementById('bigclass');
        bigClass = bigClass.options[bigClass.selectedIndex].text;

        let middleClass = document.getElementById('middleclass');
        middleClass = middleClass.options[middleClass.selectedIndex].text;

        let smallClass = document.getElementById('smallclass');
        smallClass = smallClass.options[smallClass.selectedIndex].text;

        let sendData = {
            bigClass : bigClass,
            middleClass : middleClass,
            smallClass : smallClass
        }

        let callback = function (data) {
            if (data.length > 0) {
                console.log(data);
                let detailSelectBox = document.createElement("select");
                detailSelectBox.id = "detailclass";
                //3분류 전체 조회 시
                let all = document.createElement("option");
                all.value = null;
                all.text = "all";
                detailSelectBox.add(all, null);
                let opt = [];
                for (i=0; i<data.length; i++) {
                    opt[i] = document.createElement("option");
                    opt[i].value = data[i];
                    opt[i].text = data[i];
                    detailSelectBox.add(opt[i], null);
                }
                document.querySelector('#selectBox').insertBefore(detailSelectBox, document.querySelector("#selectBox").childNodes[6]);
                $("#detailclass").change(function () {
                    }
                )
            }
        }
        sendAjaxPost(cpHolder + "/api/naverCategory", JSON.stringify(sendData), callback);
    }

    function drawKeywordList() {
        let bigClass = document.getElementById('bigclass');
        bigClass = bigClass.options[bigClass.selectedIndex].value;
        console.log(bigClass);

        let middleClass = document.getElementById('middleclass');
        if (middleClass !== null) {
            middleClass = middleClass.options[middleClass.selectedIndex].value;
            console.log(middleClass);
        }

        let smallClass = document.getElementById('smallclass');
        if (smallClass !== null) {
            smallClass = smallClass.options[smallClass.selectedIndex].value;
            console.log(smallClass);
        }

        let detailClass = document.getElementById('detailclass');
        if (detailClass !== null) {
            detailClass = detailClass.options[detailClass.selectedIndex].value;
            console.log(detailClass);
        }

        let classData = {
            bigClass : bigClass,
            middleClass : middleClass,
            smallClass : smallClass,
            detailClass : detailClass
        }

        classData = JSON.stringify(classData);

        document.querySelector('#keywordSearch tbody').innerHTML = '<tr><td></td></tr>';

        let callback = function (data) {
            document.querySelector('#keywordSearch tbody').innerHTML = '';
            drawKeywordTable('keywordSearch', data);
        }
        sendAjaxPost(cpHolder + "/api/keywords", classData, callback);
    }

    function drawKeywordTable(keywordSearch, data) {

        if ($('#keywordSearch')) {
            $('#keywordSearch').DataTable().destroy();
        }

        console.log(data);

        for(i=0; i<data.length; i++) {
            data[i] = {...data[i], searchCount : data[i].monthlyPcQcCnt+data[i].monthlyMobileQcCnt}
        }

        console.log(data);

        const keywordSearchTable = $('#' + keywordSearch).DataTable({
            dom: 'Bfrtip',
            buttons: [
                'excel'
            ],
            language: {
                search: '<div class="input-group">_INPUT_<span class="input-group-addon"><i class="fa fa-search"></i></span></div>',
                searchPlaceholder: '검색',
                processing: `<i class="fa fa-spinner fa-spin fa-2 fa-fw"></i><span class="sr-only"></span>`,
                zeroRecords: '검색된 데이터가 없습니다.',
                emptyTable: '데이터가 없습니다.'
            },
            columnDefs: [
                {className: 'tr', targets: [0, 1, 2, 3, 4, 5,]}
            ],
            columns: [
                {
                    data: 'relKeyword',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'relKeyword',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'bigClass',
                    render: function (data, type, row, meta) {
                        return `<a href="/information/vendorForm?id=${data}&switch=detail">${data}</a>`;
                    }
                },
                {
                    data: 'middleClass',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'smallClass',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'detailClass',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'searchCount',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'compIdx',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'compIdx',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                },
                {
                    data: 'productCount',
                    render: function (data, type, row, meta) {
                        return (data) ? data : "-";
                    }
                }
            ],
            order: [],
            pageLength: 10,
            destroy: true
        });
        Datatables.refresh(keywordSearchTable, data);
    }

    window.onload = function () {
        drawKeywordList();
    }
</script>
</html>